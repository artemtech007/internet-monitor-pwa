# üåê Internet Monitor Pro - Architecture & Logic

## üéØ –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è: "Speed-Only"

–°–∏—Å—Ç–µ–º–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ **—Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è**. –ú—ã –æ—Ç–∫–∞–∑–∞–ª–∏—Å—å –æ—Ç –ø—Ä–æ—Å—Ç—ã—Ö "–ø–∏–Ω–≥–æ–≤" –≤ –ø–æ–ª—å–∑—É —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ —Å–∫–æ—Ä–æ—Å—Ç–∏.

> **–ü—Ä–∏–Ω—Ü–∏–ø:** –ï—Å–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –º–æ–∂–µ—Ç —Å–∫–∞—á–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç ‚Äî –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –µ—Å—Ç—å. –ï—Å–ª–∏ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞ ‚Äî –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –Ω–µ—Ç.

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### 1. PWA Client (–¢–µ–ª–µ—Ñ–æ–Ω)
*   **–†–æ–ª—å:** "–ì–ª—É–ø—ã–π" –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å.
*   **–õ–æ–≥–∏–∫–∞:**
    1.  –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ WebSocket —Å–µ—Ä–≤–µ—Ä—É.
    2.  –ñ–¥–µ—Ç –∫–æ–º–∞–Ω–¥—É `speed_test_request`.
    3.  –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã: —Å–∫–∞—á–∏–≤–∞–µ—Ç 50KB –¥–∞–Ω–Ω—ã—Ö, –∑–∞–º–µ—Ä—è–µ—Ç –≤—Ä–µ–º—è.
    4.  –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç `speed_result` –æ–±—Ä–∞—Ç–Ω–æ.
*   **–ü—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Å–≤—è–∑–∏:** –ü—Ä–æ—Å—Ç–æ –ø—ã—Ç–∞–µ—Ç—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥.

### 2. WebSocket Server (VPS)
*   **–†–æ–ª—å:** –î–∏—Ä–∏–∂–µ—Ä –∏ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä.
*   **–õ–æ–≥–∏–∫–∞:**
    1.  –•—Ä–∞–Ω–∏—Ç —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤.
    2.  **–ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥:** –†–∞—Å—Å—ã–ª–∞–µ—Ç –≤—Å–µ–º –∫–æ–º–∞–Ω–¥—É `speed_test_request`.
    3.  **–¢–∞–π–º–µ—Ä –æ–∂–∏–¥–∞–Ω–∏—è (Watchdog):** –ï—Å–ª–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 15 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–µ –ø—Ä–∏—à–µ–ª –æ—Ç–≤–µ—Ç ‚Äî —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç —Ä–∞–∑—Ä—ã–≤ —Å–≤—è–∑–∏.
    4.  **–û—Ç—á–µ—Ç–Ω–æ—Å—Ç—å:** –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ N8N (—É—Å–ø–µ—à–Ω—ã–π —Ç–µ—Å—Ç –∏–ª–∏ –æ—à–∏–±–∫—É).

### 3. N8N (Webhook)
*   **–†–æ–ª—å:** –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.
*   **–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:** –ü–æ–ª—É—á–∞–µ—Ç JSON –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.
*   **–ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞:**
    *   `speedMbps > 0` ‚Üí ‚úÖ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç.
    *   `speedMbps == 0` (–∏–ª–∏ type `connection_lost`) ‚Üí ‚ùå –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –ø—Ä–æ–ø–∞–ª (–∞–ª–µ—Ä—Ç).

---

## üì° –ü—Ä–æ—Ç–æ–∫–æ–ª –æ–±–º–µ–Ω–∞ (WebSocket)

### Client -> Server

1.  **Auth (–ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏):**
    ```json
    {
      "type": "auth",
      "token": "PHONE001",
      "deviceId": "device_123..."
    }
    ```

2.  **Speed Result (–ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞):**
    ```json
    {
      "type": "speed_result",
      "speedMbps": 45.5,
      "duration": 120,
      "bytes": 50000
    }
    ```

### Server -> Client

1.  **Welcome:**
    ```json
    { "type": "welcome", "message": "Connected..." }
    ```

2.  **Request Test:**
    ```json
    {
      "type": "speed_test_request",
      "fileSize": 50000
    }
    ```

---

## üìä –§–æ—Ä–º–∞—Ç Webhook (–¥–ª—è N8N)

–°–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç GET –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤–∞—à N8N Webhook —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:

**1. –£—Å–ø–µ—à–Ω—ã–π —Ç–µ—Å—Ç:**
```json
{
  "type": "speed_result",
  "deviceId": "device_...",
  "token": "PHONE001",
  "speedMbps": 45.5,
  "success": "true",
  "timestamp": 1700000000
}
```

**2. –ü–æ—Ç–µ—Ä—è —Å–≤—è–∑–∏ (Connection Lost):**
```json
{
  "type": "connection_lost",
  "deviceId": "device_...",
  "token": "PHONE001",
  "speedMbps": 0,          // <-- –ú–∞—Ä–∫–µ—Ä –ø—Ä–æ–±–ª–µ–º—ã
  "reason": "test_timeout", // –∏–ª–∏ "socket_closed"
  "timestamp": 1700000000
}
```

---

## üõ†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

–í —Ñ–∞–π–ª–µ `server_websocket/server.js`:

```javascript
const TEST_INTERVAL_MS = 30000; // –ò–Ω—Ç–µ—Ä–≤–∞–ª —Ç–µ—Å—Ç–æ–≤ (30 —Å–µ–∫)
const TEST_TIMEOUT_MS = 15000;  // –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ (15 —Å–µ–∫)
const TEST_FILE_SIZE = 50000;   // –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (50KB)
```

–í —Ñ–∞–π–ª–µ `pwa/app.js`:

```javascript
this.settings = {
    reconnectInterval: 5000 // –ü–æ–ø—ã—Ç–∫–∞ —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–∞ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫
};
```

